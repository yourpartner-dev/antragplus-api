# Mail Service Documentation

This document provides an overview of the Mail Service, located in `src/services/mail/`. This service is responsible for sending emails, utilizing templates and allowing for customization.

## Core Functionality

*   **Sending Emails:** The service uses `nodemailer` to send emails. It can be configured with SMTP settings via environment variables.
*   **Template Rendering:** Emails are rendered using the `liquidjs` templating engine. This allows for dynamic content in emails.
*   **Customization:** Supports custom email templates and logos, allowing for white-labeling or branding per organization.
*   **Internationalization:** Email templates can be provided in different languages (e.g., `template-en.liquid`, `template-de.liquid`).

## Key Components

### 1. `MailService` (`src/services/mail/index.ts`)

This is the main class for sending emails.

*   **Constructor:**
    *   Initializes `nodemailer` (`this.mailer`).
    *   Initializes the `liquidjs` engine (`liquidEngine`) with paths to system and custom templates.
    *   Optionally verifies the mailer connection if `EMAIL_VERIFY_SETUP` is true.
*   **`send(options: EmailOptions)`:**
    *   This is the primary method for sending an email.
    *   It takes `EmailOptions` which extend `nodemailer`'s `SendMailOptions` and include additional properties for templating (`template.name`, `template.data`), `organization_id` (for fetching organization-specific settings), and `language`.
    *   Allows modification of the email payload via the `email.send` event hook using `emitter.emitFilter`.
    *   Retrieves default template data (project name, logo, color, URL, from-email) using `getDefaultTemplateData()`, which can be organization-specific.
    *   Constructs the `from` address using the project name and from-email.
    *   If a `template` is specified in options, it renders the HTML content using `renderTemplate()`.
    *   Trims lines in the HTML to avoid issues with line length in some email clients.
    *   Sends the email using `this.mailer.sendMail()`.
*   **`renderTemplate(template: string, variables: Record<string, any>, language: string)`:**
    *   Determines the correct template file path based on the template name and language (e.g., `template-en.liquid`).
    *   Prioritizes custom templates from `env['EMAIL_TEMPLATES_PATH']` over system templates in `src/services/mail/templates/`.
    *   Reads the template file and renders it using `liquidEngine.parseAndRender()` with the provided variables.
*   **`getDefaultTemplateData(organization_id: string | null)`:**
    *   Fetches organization-specific settings (`project_name`, `project_logo`, `project_color`, `project_url`, `project_from_email`) from the `yp_settings` table based on `organization_id`.
    *   Provides fallback values if no specific settings are found or if `organization_id` is null.
    *   Constructs the `projectLogo` URL using `getProjectLogoURL()`.
*   **`getProjectLogoURL(logoID: string, url: string)`:**
    *   Generates a full URL for the project logo, typically by appending `/assets/<logoID>` to the base public URL.

### 2. Templates (`src/services/mail/templates/`)

This directory contains the default Liquid templates used for emails. Examples include:

*   `base.liquid`: A base template that other specific templates might extend or include.
*   `password-reset-en.liquid`: Template for password reset emails in English.
*   `user-invitation-de.liquid`: Template for user invitation emails in German.

Templates are named with a language suffix (e.g., `-en`, `-de`) to support internationalization. The service will look for `templateName-language.liquid` first in the custom path, then in the system path.

### 3. Logos (`src/services/mail/logos/`)

This directory likely contains default or fallback logo images that can be referenced in email templates. The actual logos used can be customized via the `project_logo` setting in `yp_settings` which would point to an asset ID.

## Templating

*   **Engine:** `liquidjs`.
*   **Structure:** Email content is generated by rendering `.liquid` template files.
*   **Data:** The `send` method populates templates with:
    *   `defaultTemplateData`: Project name, logo, color, URL, from-email (can be organization-specific).
    *   `template.data`: Custom data passed in the `EmailOptions` for a specific email.
*   **Language Support:** The `renderTemplate` method selects the appropriate template file based on the `language` parameter (e.g., `en` for English, `de` for German). It defaults to `en` if the specified language is not `de-DE`.
*   **Custom Templates:** Custom templates can be placed in the directory specified by the `EMAIL_TEMPLATES_PATH` environment variable. These will override the system templates if they have the same name.

## Configuration (Environment Variables)

The mail service relies on several environment variables for its configuration:

*   `EMAIL_FROM`: Default "from" email address.
*   `EMAIL_HOST`: SMTP server host.
*   `EMAIL_PORT`: SMTP server port.
*   `EMAIL_USERNAME`: SMTP username.
*   `EMAIL_PASSWORD`: SMTP password.
*   `EMAIL_SECURE`: Whether to use SSL/TLS (true/false).
*   `EMAIL_IGNORE_TLS`: Whether to ignore TLS errors (true/false).
*   `EMAIL_SELF_SIGNED`: Whether to allow self-signed certificates (true/false).
*   `EMAIL_VERIFY_SETUP`: If `true`, verifies the mailer connection on service initialization.
*   `EMAIL_TEMPLATES_PATH`: Path to the directory containing custom email templates.
*   `PUBLIC_URL`: Base public URL of the application, used for constructing links and logo URLs in emails.

## Extensibility

The `MailService.send()` method uses `emitter.emitFilter('email.send', options, ...)` before processing and sending the email. This allows other parts of the application to hook into the email sending process to modify the `EmailOptions` payload dynamically. For example, a hook could add or change recipients, modify the subject, or alter template data. 